# Script de setup automatique de la base de donn√©es PostgreSQL pour Simplix CRM
# Compatible: Windows 10/11
# Usage: .\setup-database.ps1

param(
    [switch]$SkipInstall,
    [switch]$LoadSeeds = $true
)

$ErrorActionPreference = "Stop"

# Configuration par d√©faut
$DB_NAME = "simplix_crm"
$DB_PORT = "5432"
$DB_HOST = "localhost"
$POSTGRES_VERSION = "14"

# Fonction pour afficher un titre
function Write-Title {
    param([string]$Text)
    Write-Host ""
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë  $Text" -ForegroundColor Cyan
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
    Write-Host ""
}

# Fonction pour afficher une section
function Write-Section {
    param([string]$Text)
    Write-Host ""
    Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
    Write-Host "  $Text" -ForegroundColor Yellow
    Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
}

# Fonction pour v√©rifier si une commande existe
function Test-CommandExists {
    param([string]$Command)
    $null -ne (Get-Command $Command -ErrorAction SilentlyContinue)
}

# Fonction pour v√©rifier si PostgreSQL est install√©
function Test-PostgreSQLInstalled {
    # Chercher dans les emplacements d'installation courants
    $possiblePaths = @(
        "C:\Program Files\PostgreSQL\$POSTGRES_VERSION\bin\psql.exe",
        "C:\Program Files\PostgreSQL\15\bin\psql.exe",
        "C:\Program Files\PostgreSQL\13\bin\psql.exe",
        "C:\Program Files (x86)\PostgreSQL\$POSTGRES_VERSION\bin\psql.exe"
    )

    foreach ($path in $possiblePaths) {
        if (Test-Path $path) {
            return $path
        }
    }

    # V√©rifier dans le PATH
    if (Test-CommandExists "psql") {
        return "psql"
    }

    return $null
}

Clear-Host
Write-Title "Simplix CRM - Database Setup Script"
Write-Host "    PostgreSQL Installation & Configuration" -ForegroundColor Cyan
Write-Host ""

# √âtape 1: Installation de PostgreSQL
Write-Section "üì¶ √âtape 1/5: V√©rification/Installation de PostgreSQL"

$psqlPath = Test-PostgreSQLInstalled

if ($psqlPath) {
    Write-Host "‚úì PostgreSQL est d√©j√† install√©" -ForegroundColor Green
    $psqlVersion = & $psqlPath --version
    Write-Host "  Version: $psqlVersion" -ForegroundColor Blue
} elseif ($SkipInstall) {
    Write-Host "‚ùå PostgreSQL n'est pas install√© et -SkipInstall est activ√©" -ForegroundColor Red
    exit 1
} else {
    Write-Host "PostgreSQL n'est pas install√©. Installation en cours..." -ForegroundColor Yellow
    Write-Host ""

    # V√©rifier si Chocolatey est install√©
    if (Test-CommandExists "choco") {
        Write-Host "Installation via Chocolatey..." -ForegroundColor Blue
        choco install postgresql$POSTGRES_VERSION -y --params '/Password:postgres'

        # Rafra√Æchir les variables d'environnement
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

        Write-Host "‚úì PostgreSQL install√© via Chocolatey" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  Chocolatey n'est pas install√©" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "Options d'installation:" -ForegroundColor Cyan
        Write-Host "  1. Installer via Chocolatey (recommand√©)" -ForegroundColor White
        Write-Host "  2. T√©l√©charger l'installeur officiel" -ForegroundColor White
        Write-Host "  3. Quitter" -ForegroundColor White
        Write-Host ""
        $choice = Read-Host "Votre choix (1-3)"

        switch ($choice) {
            "1" {
                Write-Host ""
                Write-Host "Installation de Chocolatey..." -ForegroundColor Blue
                Set-ExecutionPolicy Bypass -Scope Process -Force
                [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
                Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

                Write-Host "Installation de PostgreSQL..." -ForegroundColor Blue
                choco install postgresql$POSTGRES_VERSION -y --params '/Password:postgres'

                # Rafra√Æchir les variables d'environnement
                $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

                Write-Host "‚úì PostgreSQL install√©" -ForegroundColor Green
            }
            "2" {
                Write-Host ""
                Write-Host "T√©l√©chargement de l'installeur PostgreSQL..." -ForegroundColor Blue
                $installerUrl = "https://get.enterprisedb.com/postgresql/postgresql-$POSTGRES_VERSION-windows-x64.exe"
                $installerPath = "$env:TEMP\postgresql-installer.exe"

                # T√©l√©charger l'installeur
                Write-Host "T√©l√©chargement depuis $installerUrl" -ForegroundColor Gray
                Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath

                Write-Host "Lancement de l'installeur..." -ForegroundColor Blue
                Write-Host "‚ö†Ô∏è  Veuillez suivre les instructions de l'installeur" -ForegroundColor Yellow
                Write-Host "   - Mot de passe par d√©faut sugg√©r√©: postgres" -ForegroundColor Gray
                Write-Host "   - Port par d√©faut: 5432" -ForegroundColor Gray

                Start-Process -FilePath $installerPath -Wait

                # Nettoyer
                Remove-Item $installerPath -ErrorAction SilentlyContinue

                Write-Host "‚úì Installation termin√©e" -ForegroundColor Green
                Write-Host "‚ö†Ô∏è  Veuillez red√©marrer ce script apr√®s l'installation" -ForegroundColor Yellow
                Read-Host "Appuyez sur Entr√©e pour quitter"
                exit 0
            }
            "3" {
                Write-Host "Installation annul√©e" -ForegroundColor Yellow
                exit 0
            }
            default {
                Write-Host "‚ùå Choix invalide" -ForegroundColor Red
                exit 1
            }
        }
    }

    # Attendre que le service d√©marre
    Write-Host "D√©marrage du service PostgreSQL..." -ForegroundColor Blue
    Start-Sleep -Seconds 5

    # Mettre √† jour le chemin psql
    $psqlPath = Test-PostgreSQLInstalled
    if (-not $psqlPath) {
        Write-Host "‚ùå PostgreSQL n'a pas √©t√© trouv√© apr√®s l'installation" -ForegroundColor Red
        Write-Host "Veuillez red√©marrer votre terminal et r√©ex√©cuter ce script" -ForegroundColor Yellow
        exit 1
    }
}

# V√©rifier que le service PostgreSQL est d√©marr√©
Write-Host "V√©rification du service PostgreSQL..." -ForegroundColor Blue
$service = Get-Service -Name "postgresql*" -ErrorAction SilentlyContinue | Select-Object -First 1

if ($service) {
    if ($service.Status -ne "Running") {
        Write-Host "D√©marrage du service PostgreSQL..." -ForegroundColor Yellow
        Start-Service $service.Name
        Start-Sleep -Seconds 3
    }
    Write-Host "‚úì Service PostgreSQL actif" -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  Service PostgreSQL non trouv√©, mais psql est disponible" -ForegroundColor Yellow
}

Start-Sleep -Seconds 2

# √âtape 2: Configuration de l'utilisateur
Write-Section "üìù √âtape 2/5: Configuration de l'utilisateur"

Write-Host "Configuration de l'utilisateur PostgreSQL" -ForegroundColor Blue
Write-Host ""
Write-Host "Options:" -ForegroundColor Cyan
Write-Host "  1. Utiliser l'utilisateur postgres par d√©faut" -ForegroundColor White
Write-Host "  2. Cr√©er un nouvel utilisateur" -ForegroundColor White
Write-Host ""
$userChoice = Read-Host "Votre choix (1-2) [1]"

if ([string]::IsNullOrWhiteSpace($userChoice)) {
    $userChoice = "1"
}

if ($userChoice -eq "2") {
    $DB_USER = Read-Host "Nom d'utilisateur"
    $DB_PASSWORD = Read-Host "Mot de passe" -AsSecureString
    $DB_PASSWORD_TEXT = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($DB_PASSWORD))

    # Cr√©er l'utilisateur
    Write-Host "Cr√©ation de l'utilisateur $DB_USER..." -ForegroundColor Blue
    $createUserCmd = "CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD_TEXT'; ALTER USER $DB_USER CREATEDB;"

    try {
        $env:PGPASSWORD = "postgres"
        & $psqlPath -U postgres -c $createUserCmd 2>&1 | Out-Null
        Write-Host "‚úì Utilisateur $DB_USER cr√©√©" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è  Erreur lors de la cr√©ation de l'utilisateur: $_" -ForegroundColor Yellow
    }
} else {
    $DB_USER = "postgres"
    $DB_PASSWORD_TEXT = Read-Host "Mot de passe pour postgres (laisser vide si configur√© lors de l'installation)" -AsSecureString
    if ($DB_PASSWORD_TEXT.Length -gt 0) {
        $DB_PASSWORD_TEXT = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($DB_PASSWORD_TEXT))
    } else {
        $DB_PASSWORD_TEXT = "postgres"
    }
    Write-Host "‚úì Utilisation de l'utilisateur postgres" -ForegroundColor Green
}

$env:PGPASSWORD = $DB_PASSWORD_TEXT

Start-Sleep -Seconds 1

# √âtape 3: Cr√©ation de la base de donn√©es
Write-Section "üóÑÔ∏è  √âtape 3/5: Cr√©ation de la base de donn√©es"

# V√©rifier si la base existe d√©j√†
Write-Host "V√©rification de l'existence de la base '$DB_NAME'..." -ForegroundColor Blue

try {
    $dbExists = & $psqlPath -U $DB_USER -lqt 2>&1 | Select-String -Pattern $DB_NAME -Quiet

    if ($dbExists) {
        Write-Host "‚ö†Ô∏è  La base de donn√©es '$DB_NAME' existe d√©j√†" -ForegroundColor Yellow
        $recreate = Read-Host "Voulez-vous la supprimer et la recr√©er ? (y/n) [n]"

        if ($recreate -eq "y") {
            Write-Host "Suppression de la base existante..." -ForegroundColor Yellow
            & $psqlPath -U $DB_USER -c "DROP DATABASE IF EXISTS $DB_NAME;" 2>&1 | Out-Null
            Write-Host "‚úì Base de donn√©es supprim√©e" -ForegroundColor Green
            $dbExists = $false
        } else {
            Write-Host "‚ÑπÔ∏è  Conservation de la base de donn√©es existante" -ForegroundColor Blue
        }
    }

    if (-not $dbExists) {
        Write-Host "Cr√©ation de la base de donn√©es '$DB_NAME'..." -ForegroundColor Blue
        & $psqlPath -U $DB_USER -c "CREATE DATABASE $DB_NAME;" 2>&1 | Out-Null
        Write-Host "‚úì Base de donn√©es '$DB_NAME' cr√©√©e" -ForegroundColor Green
    }
} catch {
    Write-Host "‚ùå Erreur lors de la cr√©ation de la base: $_" -ForegroundColor Red
    exit 1
}

Start-Sleep -Seconds 1

# √âtape 4: Application des migrations
Write-Section "üöÄ √âtape 4/5: Application des migrations"

# Cr√©er le fichier .env
$envContent = @"
DB_HOST=$DB_HOST
DB_PORT=$DB_PORT
DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASSWORD_TEXT
"@

Set-Content -Path ".env" -Value $envContent
Write-Host "‚úì Fichier .env cr√©√©" -ForegroundColor Green

# D√©finir les variables d'environnement pour cette session
$env:DB_HOST = $DB_HOST
$env:DB_PORT = $DB_PORT
$env:DB_NAME = $DB_NAME
$env:DB_USER = $DB_USER
$env:DB_PASSWORD = $DB_PASSWORD_TEXT

# Appliquer les migrations
Write-Host "Application des migrations SQL..." -ForegroundColor Blue
Write-Host ""

try {
    .\migrate.ps1 up
} catch {
    Write-Host "‚ùå Erreur lors des migrations: $_" -ForegroundColor Red
    exit 1
}

Start-Sleep -Seconds 1

# √âtape 5: Chargement des donn√©es de d√©monstration
Write-Section "üìä √âtape 5/5: Chargement des donn√©es de d√©monstration"

if ($LoadSeeds) {
    $loadSeedsChoice = Read-Host "Voulez-vous charger les donn√©es de d√©monstration ? (y/n) [y]"
    if ([string]::IsNullOrWhiteSpace($loadSeedsChoice)) {
        $loadSeedsChoice = "y"
    }
} else {
    $loadSeedsChoice = "n"
}

if ($loadSeedsChoice -eq "y") {
    Write-Host "Chargement des donn√©es de seed..." -ForegroundColor Blue

    if (Test-Path "seeds\001_default_data.sql") {
        & $psqlPath -U $DB_USER -d $DB_NAME -f "seeds\001_default_data.sql" 2>&1 | Out-Null
        Write-Host "‚úì Donn√©es de d√©monstration charg√©es" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  Fichier seeds\001_default_data.sql non trouv√©" -ForegroundColor Yellow
    }
} else {
    Write-Host "‚ÑπÔ∏è  Pas de donn√©es de d√©monstration charg√©es" -ForegroundColor Blue
}

# R√©sum√© final
Write-Host ""
Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
Write-Host "‚ïë              ‚úÖ Installation termin√©e !                    ‚ïë" -ForegroundColor Green
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
Write-Host ""

Write-Host "üìã Informations de connexion:" -ForegroundColor Cyan
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
Write-Host "Host:     " -NoNewline -ForegroundColor Blue
Write-Host $DB_HOST
Write-Host "Port:     " -NoNewline -ForegroundColor Blue
Write-Host $DB_PORT
Write-Host "Database: " -NoNewline -ForegroundColor Blue
Write-Host $DB_NAME
Write-Host "User:     " -NoNewline -ForegroundColor Blue
Write-Host $DB_USER
if ($DB_PASSWORD_TEXT) {
    Write-Host "Password: " -NoNewline -ForegroundColor Blue
    Write-Host "********"
}
Write-Host ""

Write-Host "üîß Commandes utiles:" -ForegroundColor Cyan
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
Write-Host "# Se connecter √† la base" -ForegroundColor Green
Write-Host "  psql -U $DB_USER -d $DB_NAME"
Write-Host ""
Write-Host "# Voir le statut des migrations" -ForegroundColor Green
Write-Host "  .\migrate.ps1 status"
Write-Host ""
Write-Host "# Appliquer de nouvelles migrations" -ForegroundColor Green
Write-Host "  .\migrate.ps1 up"
Write-Host ""
Write-Host "# Cr√©er une nouvelle migration" -ForegroundColor Green
Write-Host "  .\migrate.ps1 create nom_de_la_migration"
Write-Host ""
Write-Host "# R√©initialiser compl√®tement la base" -ForegroundColor Green
Write-Host "  .\migrate.ps1 reset"
Write-Host ""

Write-Host "üìö Documentation:" -ForegroundColor Cyan
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
Write-Host "  - README.md                    - Documentation compl√®te de la BDD"
Write-Host "  - ..\docs\MIGRATION_GUIDE.md   - Guide de migration"
Write-Host "  - ..\docs\STATUS.md            - √âtat du projet"
Write-Host ""
Write-Host "üéâ La base de donn√©es Simplix CRM est pr√™te √† l'emploi !" -ForegroundColor Green
Write-Host ""
