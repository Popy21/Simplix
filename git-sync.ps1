# Script de synchronisation Git automatique AVANC√â (PowerShell)
# G√®re: stash, overwrites, conflicts, et garde tout sur main

$ErrorActionPreference = "Continue"

Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë          üîÑ Git Sync - Synchronisation Avanc√©e             ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
Write-Host ""

# V√©rifier si on est dans un d√©p√¥t Git
try {
    git rev-parse --git-dir 2>&1 | Out-Null
    if ($LASTEXITCODE -ne 0) {
        throw "Pas dans un d√©p√¥t Git"
    }
} catch {
    Write-Host "‚ùå Erreur: Pas dans un d√©p√¥t Git" -ForegroundColor Red
    exit 1
}

# S'assurer qu'on est sur main
$currentBranch = git branch --show-current
if ($currentBranch -ne "main") {
    Write-Host "‚ö†Ô∏è  Vous √™tes sur la branche '$currentBranch'" -ForegroundColor Yellow
    $switchBranch = Read-Host "Voulez-vous passer sur 'main' ? (y/n) [y]"
    if ([string]::IsNullOrWhiteSpace($switchBranch)) {
        $switchBranch = "y"
    }

    if ($switchBranch -eq "y") {
        Write-Host "üìç Passage sur la branche main..." -ForegroundColor Blue

        # Sauvegarder les modifications locales
        $status = git status -s
        if ($status) {
            Write-Host "üíæ Sauvegarde des modifications locales (stash)..." -ForegroundColor Yellow
            git stash push -m "Auto-stash before switching to main $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }

        git checkout main

        # Restaurer le stash si besoin
        $stashList = git stash list
        if ($stashList -match "Auto-stash before switching to main") {
            Write-Host "üì• Restauration des modifications..." -ForegroundColor Blue
            git stash pop
        }
    } else {
        Write-Host "‚ùå Synchronisation annul√©e" -ForegroundColor Red
        exit 1
    }
}

Write-Host "‚úì Sur la branche main" -ForegroundColor Green
Write-Host ""

# Configurer Git pour toujours merger
git config pull.rebase false 2>$null

# R√©cup√©rer les informations du remote
Write-Host "üåê R√©cup√©ration des informations du remote..." -ForegroundColor Blue
git fetch origin main 2>&1 | Out-Null

# V√©rifier s'il y a des modifications locales
$hasLocalChanges = $false
$status = git status -s
if ($status) {
    Write-Host "üìù Modifications locales d√©tect√©es" -ForegroundColor Yellow
    $hasLocalChanges = $true

    # Afficher un r√©sum√©
    Write-Host ""
    git status --short
    Write-Host ""
} else {
    Write-Host "‚úì Pas de modifications locales" -ForegroundColor Green
}

# Comparer avec le remote
$local = git rev-parse main
$remote = git rev-parse origin/main 2>$null
$base = git merge-base main origin/main 2>$null

if (-not $remote) {
    Write-Host "‚ùå Erreur: Pas de branche remote 'origin/main'" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan

# CAS 1: D√©j√† √† jour
if ($local -eq $remote) {
    Write-Host "‚úì D√©j√† √† jour avec origin/main" -ForegroundColor Green

    if ($hasLocalChanges) {
        Write-Host ""
        Write-Host "üì§ Vous avez des modifications locales √† push" -ForegroundColor Yellow
        Write-Host ""
        $commitMsg = Read-Host "Message de commit"

        if ([string]::IsNullOrWhiteSpace($commitMsg)) {
            $commitMsg = "Update $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }

        Write-Host "üíæ Commit des modifications..." -ForegroundColor Blue
        git add .
        git commit -m $commitMsg

        Write-Host "üì§ Push vers origin/main..." -ForegroundColor Blue
        git push origin main

        Write-Host "‚úÖ Modifications push√©es avec succ√®s" -ForegroundColor Green
    } else {
        Write-Host "‚úÖ Rien √† faire, tout est synchronis√©" -ForegroundColor Green
    }

# CAS 2: En retard
} elseif ($local -eq $base) {
    Write-Host "üì• Vous √™tes en retard par rapport au remote" -ForegroundColor Yellow

    # Commit les modifications locales d'abord
    if ($hasLocalChanges) {
        Write-Host ""
        Write-Host "üíæ Commit des modifications locales avant pull..." -ForegroundColor Yellow
        Write-Host ""
        $commitMsg = Read-Host "Message de commit"

        if ([string]::IsNullOrWhiteSpace($commitMsg)) {
            $commitMsg = "WIP: Auto-commit before pull $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }

        git add .
        git commit -m $commitMsg
        Write-Host "‚úì Modifications committ√©es" -ForegroundColor Green
    }

    Write-Host ""
    Write-Host "üì• Pull des modifications distantes..." -ForegroundColor Blue

    git pull origin main --no-edit 2>&1 | Out-Null

    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Pull r√©ussi !" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Conflit d√©tect√© lors du pull" -ForegroundColor Red
        Write-Host ""
        Write-Host "üîß R√©solution des conflits..." -ForegroundColor Yellow
        Write-Host ""

        # Afficher les fichiers en conflit
        Write-Host "Fichiers en conflit:" -ForegroundColor Cyan
        git diff --name-only --diff-filter=U
        Write-Host ""

        $keepOurs = Read-Host "Voulez-vous accepter TOUTES vos modifications locales ? (y/n) [y]"
        if ([string]::IsNullOrWhiteSpace($keepOurs)) {
            $keepOurs = "y"
        }

        if ($keepOurs -eq "y") {
            Write-Host "üìù Acceptation de vos modifications locales..." -ForegroundColor Yellow
            git checkout --ours .
            git add .
            git commit -m "Merge: Keep local changes $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            Write-Host "‚úÖ Conflits r√©solus (vos modifications gard√©es)" -ForegroundColor Green
        } else {
            $keepTheirs = Read-Host "Voulez-vous accepter TOUTES les modifications distantes ? (y/n) [n]"

            if ($keepTheirs -eq "y") {
                Write-Host "üìù Acceptation des modifications distantes..." -ForegroundColor Yellow
                git checkout --theirs .
                git add .
                git commit -m "Merge: Keep remote changes $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                Write-Host "‚úÖ Conflits r√©solus (modifications distantes gard√©es)" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Veuillez r√©soudre les conflits manuellement" -ForegroundColor Red
                Write-Host ""
                Write-Host "Commandes utiles:"
                Write-Host "  git status                    # Voir les conflits"
                Write-Host "  git checkout --ours fichier   # Garder votre version"
                Write-Host "  git checkout --theirs fichier # Garder la version distante"
                Write-Host "  git add .                     # Marquer comme r√©solu"
                Write-Host "  git commit                    # Finaliser le merge"
                Write-Host "  git merge --abort             # Annuler compl√®tement"
                exit 1
            }
        }
    }

# CAS 3: En avance
} elseif ($remote -eq $base) {
    Write-Host "üì§ Vous √™tes en avance par rapport au remote" -ForegroundColor Blue

    if ($hasLocalChanges) {
        Write-Host ""
        Write-Host "üíæ Commit des modifications..." -ForegroundColor Yellow
        Write-Host ""
        $commitMsg = Read-Host "Message de commit"

        if ([string]::IsNullOrWhiteSpace($commitMsg)) {
            $commitMsg = "Update $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }

        git add .
        git commit -m $commitMsg
        Write-Host "‚úì Modifications committ√©es" -ForegroundColor Green
    }

    Write-Host ""
    Write-Host "üì§ Push vers origin/main..." -ForegroundColor Blue
    git push origin main
    Write-Host "‚úÖ Push r√©ussi !" -ForegroundColor Green

# CAS 4: Divergence
} else {
    Write-Host "‚ö†Ô∏è  DIVERGENCE D√âTECT√âE" -ForegroundColor Red
    Write-Host ""
    Write-Host "Vos commits locaux et les commits distants ont diverg√©."
    Write-Host ""

    # Afficher les commits divergents
    Write-Host "üìä Vos commits locaux (absents du remote):" -ForegroundColor Cyan
    git log --oneline origin/main..main | Select-Object -First 5
    Write-Host ""
    Write-Host "üìä Commits distants (absents en local):" -ForegroundColor Cyan
    git log --oneline main..origin/main | Select-Object -First 5
    Write-Host ""

    # Commit les modifications locales
    if ($hasLocalChanges) {
        Write-Host "üíæ Commit des modifications locales..." -ForegroundColor Yellow
        Write-Host ""
        $commitMsg = Read-Host "Message de commit"

        if ([string]::IsNullOrWhiteSpace($commitMsg)) {
            $commitMsg = "WIP: Auto-commit $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        }

        git add .
        git commit -m $commitMsg
        Write-Host "‚úì Modifications committ√©es" -ForegroundColor Green
        Write-Host ""
    }

    Write-Host "Choisissez la strat√©gie:" -ForegroundColor Yellow
    Write-Host "  1) FORCER AVEC VOS MODIFICATIONS (overwrites remote) ‚ö†Ô∏è"
    Write-Host "  2) Merge (combine les deux historiques)"
    Write-Host "  3) Rebase (applique vos commits apr√®s le remote)"
    Write-Host "  4) Annuler"
    Write-Host ""
    $strategy = Read-Host "Votre choix (1-4)"

    switch ($strategy) {
        "1" {
            Write-Host ""
            Write-Host "‚ö†Ô∏è  ATTENTION: Cela va √âCRASER les modifications distantes !" -ForegroundColor Red
            $confirm = Read-Host "√ätes-vous S√õR ? Tapez 'FORCE' pour confirmer"

            if ($confirm -eq "FORCE") {
                Write-Host "üí™ Force push vers origin/main..." -ForegroundColor Yellow
                git push --force origin main
                Write-Host "‚úÖ Push forc√© r√©ussi (remote √©cras√©)" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Annul√© (confirmation incorrecte)" -ForegroundColor Red
                exit 1
            }
        }
        "2" {
            Write-Host "üîÄ Merge des branches..." -ForegroundColor Blue
            git pull origin main --no-edit 2>&1 | Out-Null

            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Merge r√©ussi" -ForegroundColor Green
                Write-Host "üì§ Push du r√©sultat..." -ForegroundColor Blue
                git push origin main
                Write-Host "‚úÖ Synchronisation compl√®te" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Conflit lors du merge" -ForegroundColor Red
                Write-Host ""
                $keepOurs = Read-Host "Garder VOS modifications ? (y/n) [y]"
                if ([string]::IsNullOrWhiteSpace($keepOurs)) {
                    $keepOurs = "y"
                }

                if ($keepOurs -eq "y") {
                    git checkout --ours .
                    git add .
                    git commit -m "Merge: Keep local changes"
                    git push origin main
                    Write-Host "‚úÖ Conflits r√©solus (vos modifs gard√©es)" -ForegroundColor Green
                } else {
                    git checkout --theirs .
                    git add .
                    git commit -m "Merge: Keep remote changes"
                    git push origin main
                    Write-Host "‚úÖ Conflits r√©solus (modifs distantes gard√©es)" -ForegroundColor Green
                }
            }
        }
        "3" {
            Write-Host "üîÑ Rebase sur origin/main..." -ForegroundColor Blue
            git pull --rebase origin main 2>&1 | Out-Null

            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Rebase r√©ussi" -ForegroundColor Green
                Write-Host "üì§ Push des modifications..." -ForegroundColor Blue
                git push origin main
                Write-Host "‚úÖ Push r√©ussi" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Conflit lors du rebase" -ForegroundColor Red
                Write-Host ""
                Write-Host "R√©solvez les conflits puis:"
                Write-Host "  git add ."
                Write-Host "  git rebase --continue"
                Write-Host "  git push origin main"
                Write-Host ""
                Write-Host "Ou annulez avec: git rebase --abort"
                exit 1
            }
        }
        default {
            Write-Host "‚ùå Synchronisation annul√©e" -ForegroundColor Red
            exit 1
        }
    }
}

Write-Host ""
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host "üéâ Synchronisation termin√©e !" -ForegroundColor Green
Write-Host ""

# Afficher le statut final
Write-Host "üìä Statut final:" -ForegroundColor Cyan
git status --short --branch
Write-Host ""
Write-Host "‚úÖ Vous √™tes sur 'main' et tout est synchronis√©" -ForegroundColor Green
